// We should be using delegates for the click handlers, but w/e
Number.prototype.formatMoney = function(c, d, t){
    var n = this, c = isNaN(c = Math.abs(c)) ? 2 : c, d = d == undefined ? "," : d, t = t == undefined ? "." : t, s = n < 0 ? "-" : "", i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", j = (j = i.length) > 3 ? j % 3 : 0;
    return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
};

Shadowbox.init();

window.jan1 = new Date(2011, 0, 1);
window.party_strings = {
    "0": "Republican",
    "1": "Democrat",
    "2": "Libertarian"
};

window.party_named_strings = {
    "0": "Republican",
    "1": "Democratic",
    "2": "Libertarian"
};

window.str_to_partyid = {
    "Republican": 0,
    "Democrat": 1,
    "Libertarian": 2
}

window.party_colors = {
    "0": "#B2182B",
    "1": "#4393c3",
    "2": "#FCB514"
};

window.bar_status = {
    "stacked": true,
    "bar_width": 450,
    "bar_height": 335
};

window.boxwhisker_status = {
    "show_outliers": true
}

$(document).ready(function() {

    $("#map_all_party_button").click(function(e) {
	counties.attr("class", "RdBu");
	load_map("preprocessed-data/normalized_diff_donations.json");
	$(".map_menu li").removeClass("selected");
	$("#map_all_party_li").addClass("selected");
	return false;
    });
    $("#map_republican_button").click(function(e) {
	counties.attr("class", "Reds");
	load_map("preprocessed-data/normalized_republican_donations.json");
	$(".map_menu li").removeClass("selected");
	$("#map_republican_li").addClass("selected");
	return false;
    });
    $("#map_democrat_button").click(function(e) {
	counties.attr("class", "Blues");
	load_map("preprocessed-data/normalized_democrat_donations.json");
	$(".map_menu li").removeClass("selected");
	$("#map_democrat_li").addClass("selected");
	return false;
    });
    $("#map_libertarian_button").click(function(e) {
	counties.attr("class", "Oranges");
	load_map("preprocessed-data/normalized_libertarian_donations.json");
	$(".map_menu li").removeClass("selected");
	$("#map_libertarian_li").addClass("selected");
	return false;
    });
    
    function get_checked_parties(checkboxes) {
	var checked_parties = [];
	for (party in checkboxes) {
	    if ($(checkboxes[party]).is(':checked')) {
		checked_parties.push(parseInt(party));
	    }
	}
	return checked_parties;
    }

    var bubble_party_checkboxes = [ "#bubble_checkbox_republican",
				    "#bubble_checkbox_democrat",
				    "#bubble_checkbox_libertarian" ];
    $(".bubble_checkbox").attr("checked", "checked");
    $(".bubble_checkbox").change(function(e) {
	load_bubble(get_checked_parties(bubble_party_checkboxes));
    });

    var barchart_party_checkboxes = [ "#barchart_checkbox_republican",
				      "#barchart_checkbox_democrat",
				      "#barchart_checkbox_libertarian" ];
    $(".barchart_checkbox").attr("checked", "checked");
    $(".barchart_checkbox").change(function(e) {
	load_barchart(get_checked_parties(barchart_party_checkboxes), bar_status.bar_width, bar_status.bar_height);
	if (!window.bar_status.stacked) {
	    window.bar_status.stacked = true;
	    $("#bars_stack").text("[ + ]");
	}
    });
    

    window.set_gbar_hover = function() {
	$("g.bar").hover(function() {
	    var pid = $(this).find("rect").attr("party");
	    // WHY IS THE MONTH ZERO-INDEXED IN JAVASCRIPT?
	    // -_-
	    
	    var hover_date = new Date(jan1.getTime() + 
				      parseInt($(this)
					       .find("rect")
					       .attr("week"))*1000*86400*7);
	    $("#barchart_hover_value")
		.text("$" + parseInt($(this).find("rect")
				     .attr("bar_value")).formatMoney(0, '.', ','));
	    $("#barchart_hover_text")
		.html("Week of " + (hover_date.getMonth()+1) + "/" + 
		      hover_date.getDate() + "/" + hover_date.getFullYear() + 
		      " - <span class=\"party_" + pid + "\">" + 
		      party_named_strings[pid] + "</span> Party");
	});
    }
    $("#bars_stack").click(function() {

	if (window.bar_status.stacked) {
	    barTransitions.transitionGroup();
	    window.bar_status.stacked = false;
	    $(this).text("[ - ]");
	} else {
	    barTransitions.transitionStack();
	    window.bar_status.stacked = true;
	    $(this).text("[ + ]");
	}
	return false;
    });

    $("#bars_expand").click(function() {
	
	Shadowbox.open({
            content:    "<div id='shadowbox_popup'></div>",
            player:     "html",
            title:      "Donations over Time",
            height:     500,
            width:      950, 
	    options:    {
		onFinish:   
		function () { 
		    $("#barchart_container").appendTo("#shadowbox_popup");
		    $(".barchart_checkbox").attr("checked", "checked");
		    bar_status.bar_width = 920;
		    bar_status.bar_height = 335;
		    load_barchart([0,1,2], bar_status.bar_width, bar_status.bar_height); 
		    $("#barchart_container").animate({ 'width': '950px' }, 1000);
		}
	    }
	});
	window.handle_bar_close = function() 
	{ 
	    
	    $("#barchart_container").appendTo("#barchart_placeholder"); 
	    $("#barchart_container").animate({ 'width': '500px' });
	    console.log($("#barchart_container"));
	    $(".barchart_checkbox").attr("checked", "checked");
	    bar_status.bar_width = 450;
	    bar_status.bar_height = 335;
	    load_barchart([0,1,2], bar_status.bar_width, bar_status.bar_height); 
	};
	
	return false;
    });

    $("#toggle_boxwhisker_outliers").click(function() {
	window.boxwhisker_status.show_outliers = !window.boxwhisker_status.show_outliers;
	$("#boxwhisker").empty();
	window.load_boxwhisker();
	return false;
    });

});